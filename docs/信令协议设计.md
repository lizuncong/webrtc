## 信令协议设计

采用 json 封装格式

- 1.join 加入房间
- 2.resp-join 当 join 房间后发现房间已经存在另一个人时则返回另一个人的 uid；如果只有自己则不返回
- 3.leave 离开房间，服务器收到 leave 信令则检查同一房间是否有其他人，如果有其他人则通知他有人离开
- 4.new-peer 服务器通知客户端有新人加入，收到 new-peer 则发起连接请求
- 5.peer-leave 服务器通知客户端有人离开
- 6.offer 转发 offer sdp
- 7.answer 转发 answer sdp
- 8.candidate 转发 candidate sdp

## join

```js
const jsonMsg = {
  cmd: "join",
  roomId: roomId,
  uid: localUserId,
};
```

## resp-join

```js
const jsonMsg = {
  cmd: "resp-join",
  remoteUid: remoteUid,
};
```

## leave

```js
const jsonMsg = {
  cmd: "leave",
  roomId: roomId,
  uid: localUserId,
};
```

## new-peer

```js
const jsonMsg = {
  cmd: "new-peer",
  remoteUid: uid,
};
```

## peer-leave

```js
const jsonMsg = {};
```

## offer、answer、candidate 信令实现

思路：

- 1.收到 new-peer(handleRemoteNewPeer 处理)，作为发起者创建 RTCPeerConnection，绑定事件响应函数，加入本地流
- 2.创建 offer sdp，设置本地 sdp，并将 offer sdp 发送到服务器
- 3.服务器收到 offer sdp 转发给指定的 remoteClient
- 4.接收者收到 offer，也创建 RTCPeerConnection，绑定事件响应函数，加入本地流
- 5.接收者设置远程 sdp，并创建 answer sdp，然后设置本地 sdp 并将 answer sdp 发送给服务器。
- 6.服务器收到 answer sdp 转发给指定的 remoteClient
- 7.发起者收到 answer sdp，则设置远程 sdp
- 8.发起者和接收者都收到 ontrack 回调事件，获取到对方码流的对象句柄
- 9.发起者和接收者都开始请求打洞，通过 onIceCandidate 获取到打洞信息(candidate)并发送给对方
- 10.如果 P2P 能成功则进行 P2P 通话，如果 P2P 不成功则进行中继转发通话
